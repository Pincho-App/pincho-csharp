# Cloud Build configuration for WirePusher C# Client Library
# Runs tests, code coverage checks, and builds the package

steps:
  # Step 1: Restore dependencies
  - name: 'mcr.microsoft.com/dotnet/sdk:8.0'
    id: 'restore'
    entrypoint: 'dotnet'
    args:
      - 'restore'

  # Step 2: Build solution
  - name: 'mcr.microsoft.com/dotnet/sdk:8.0'
    id: 'build'
    entrypoint: 'dotnet'
    waitFor: ['restore']
    args:
      - 'build'
      - '--configuration'
      - 'Release'
      - '--no-restore'

  # Step 3: Run tests with coverage
  - name: 'mcr.microsoft.com/dotnet/sdk:8.0'
    id: 'test'
    entrypoint: 'dotnet'
    waitFor: ['build']
    args:
      - 'test'
      - '--configuration'
      - 'Release'
      - '--no-build'
      - '--collect:XPlat Code Coverage'
      - '--results-directory'
      - './TestResults'

  # Step 4: Check coverage threshold (90%)
  - name: 'mcr.microsoft.com/dotnet/sdk:8.0'
    id: 'coverage-check'
    entrypoint: 'bash'
    waitFor: ['test']
    args:
      - '-c'
      - |
        dotnet tool install --global dotnet-reportgenerator-globaltool || true
        export PATH="$$PATH:/root/.dotnet/tools"

        reportgenerator \
          -reports:"./TestResults/**/coverage.cobertura.xml" \
          -targetdir:"./coveragereport" \
          -reporttypes:"Html;TextSummary"

        # Extract line coverage percentage
        COVERAGE=$$(grep -oP 'Line coverage: \K[0-9.]+' ./coveragereport/Summary.txt || echo "0")
        echo "Line coverage: $$COVERAGE%"

        # Check if coverage meets threshold
        if (( $$(echo "$$COVERAGE < 90.0" | bc -l) )); then
          echo "ERROR: Coverage $$COVERAGE% is below 90% threshold"
          exit 1
        fi

        echo "Coverage threshold met (>= 90%)"

  # Step 5: Pack NuGet package
  - name: 'mcr.microsoft.com/dotnet/sdk:8.0'
    id: 'pack'
    entrypoint: 'dotnet'
    waitFor: ['coverage-check']
    args:
      - 'pack'
      - 'src/WirePusher/WirePusher.csproj'
      - '--configuration'
      - 'Release'
      - '--no-build'
      - '--output'
      - './artifacts'

  # Step 6: Publish to NuGet (ONLY on Git tags)
  - name: 'mcr.microsoft.com/dotnet/sdk:8.0'
    id: 'publish'
    entrypoint: 'bash'
    waitFor: ['pack']
    secretEnv: ['NUGET_API_KEY']
    args:
      - '-c'
      - |
        if [ -n "$TAG_NAME" ]; then
          echo "Publishing version $TAG_NAME to NuGet..."
          ls -lh ./artifacts/*.nupkg

          dotnet nuget push ./artifacts/*.nupkg \
            --api-key "$$NUGET_API_KEY" \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate

          echo ""
          echo "✓ Published $TAG_NAME to NuGet"
        else
          echo "Skipping NuGet publish (not a tagged release)"
          echo "To publish: git tag v1.0.0 && git push origin v1.0.0"
        fi

  # Step 7: Send notification on successful release (only on tags)
  - name: 'curlimages/curl:latest'
    id: 'notify-release'
    waitFor: ['publish']
    entrypoint: 'sh'
    secretEnv: ['WIREPUSHER_TOKEN']
    args:
      - '-c'
      - |
        if [ -z "$TAG_NAME" ]; then
          echo "=== No Git tag detected ==="
          echo "Skipping notification (only runs on tags)"
          exit 0
        fi

        echo "=== Sending release notification via NotifAI ==="
        curl -s -X POST https://api.wirepusher.dev/notifai \
          -H "Authorization: Bearer $$WIREPUSHER_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{
            \"text\": \"WirePusher C# SDK $TAG_NAME released to NuGet successfully. Install via dotnet add package WirePusher. View package at https://www.nuget.org/packages/WirePusher/\"
          }"

        echo ""
        echo "✓ Release notification sent via NotifAI"

# Secret Manager integration
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/nuget-api-key/versions/latest
      env: 'NUGET_API_KEY'
    - versionName: projects/$PROJECT_ID/secrets/wirepusher-token/versions/latest
      env: 'WIREPUSHER_TOKEN'

timeout: '600s'
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

# Artifacts to save
artifacts:
  objects:
    location: 'gs://${PROJECT_ID}_cloudbuild/artifacts/csharp-sdk/${BUILD_ID}'
    paths:
      - 'artifacts/*.nupkg'
      - 'coveragereport/*'
      - 'TestResults/**/coverage.cobertura.xml'
